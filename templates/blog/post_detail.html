{% extends 'partials/base.html' %}
{% block title %}Post Detail Page{% endblock %}
{% load crispy_forms_tags %}
{% block content %}
<div class="container">
  <div class="row mt-5 pt-3">

    <!-- Pie chart for comment distribution -->
    <div class="col-md-3 text-center">
      <canvas id="commentsChart" style="margin: auto;"></canvas>
    </div>

    <!-- Main content -->
    <div class="col-md-9">
      <div class="card my-3 shadow">
        <div class="card-body">
          <div class="row">
            <div class="col-md-8">
              <small>{{ post.date_created }}</small>
              {% if post.author == request.user %}
                <span><a class="btn btn-danger float-right btn-sm"
                          href="{% url 'blog-post-delete' post.id %}">Delete</a></span>
                <span><a class="btn btn-primary mx-2 float-right btn-sm"
                          href="{% url 'blog-post-edit' post.id %}">Edit</a></span>
              {% endif %}
              <hr>
              <h4>{{ post.title }}</h4>
              <p>
                {{ post.content }}
              </p>
              <div>
                Average Stakeholders Opinion: <strong>{{ average_score_classification }} ({{ average_score}})</strong>
              </div>
                  <!-- Improvements list generated by AI -->
              <div class="mt-3">
                <h5>AI-generated List of Improvements (may not be 100% accurate):</h5>
                <p>
                  <ul>
                    <li><strong>Streamline Verification Process:</strong>
                        <ul>
                            <li>Simplify or improve the captcha verification to make it less annoying.</li>
                        </ul>
                    </li>
                    <li><strong>Password Requirements Guidance:</strong>
                        <ul>
                            <li>Provide clearer and more detailed guidance on password requirements.</li>
                        </ul>
                    </li>
                    <li><strong>Simplify Registration Form:</strong>
                        <ul>
                            <li>Shorten the form by removing unnecessary fields.</li>
                        </ul>
                    </li>
                    <li><strong>Clearer Error Messages:</strong>
                        <ul>
                            <li>Ensure error messages are clear and informative to help users correct issues quickly.</li>
                        </ul>
                    </li>
                    <li><strong>Password Strength Indicators:</strong>
                        <ul>
                            <li>Include password strength indicators to assist users in creating strong passwords.</li>
                        </ul>
                    </li>
                    <li><strong>Additional Guidance for Password Creation:</strong>
                        <ul>
                            <li>Offer tips or guidelines during the password creation step to help users understand what constitutes a secure password.</li>
                        </ul>
                    </li>
                    <li><strong>Improved User Experience:</strong>
                        <ul>
                            <li>Overall, make the registration process smoother and more intuitive to reduce frustration and confusion.</li>
                        </ul>
                    </li>
                </ul>
                </p>
              </div>
                </p>
              </div>
            </div>
          </div>
          <p class="mt-3">
            <a class="" data-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false"
               aria-controls="collapseExample">
              Comments: {{ post.comment_count }}
            </a>
          </p>

          <!-- Filter options -->
          <div>
            <a href="?filter=all" class="btn btn-secondary btn-sm {% if filter_type == 'all' %}active{% endif %}">All</a>
            <a href="?filter=positive" class="btn btn-success btn-sm {% if filter_type == 'positive' %}active{% endif %}">Positive</a>
            <a href="?filter=negative" class="btn btn-danger btn-sm {% if filter_type == 'negative' %}active{% endif %}">Negative</a>
            <a href="?filter=mixed" class="btn btn-warning btn-sm {% if filter_type == 'mixed' %}active{% endif %}">Mixed</a>
          </div>

          <div id="collapseExample">
            <div style="height: 250px; overflow-y: scroll;" class="card card-body">
              {% for comment in comments %}
              <div class="row comment">  
                <div class="col-md-3">
                  <img src="{{ comment.user.profilemodel.image.url }}" alt="Avatar" class="rounded-circle" style="width: 30px; height: 30px;">
                  {{ comment.user.username }}
                </div>
                <div class="col-md-9">
                  <div>
                    {% if comment.score > 0.25 %}
                      <span id="Positive" class="text-success">
                        <strong>Positive ({{ comment.score }})</strong>
                      </span>
                    {% elif comment.score < -0.25 %}
                      <span id="Negative" class="text-danger">
                        <strong>Negative ({{ comment.score }})</strong>
                      </span>
                    {% else %}
                      <span id="Mixed" class="text-warning">
                        <strong>Mixed ({{ comment.score }})</strong>
                      </span>
                    {% endif %}
                  </div>                  
                  {{ comment.content }}
                  {% if comment.user == request.user %}
                    <span><a class="btn btn-danger btn-sm"
                              href="{% url 'comment-delete' comment.id %}">Delete</a></span>
                    <span><a class="btn btn-primary mx-2 btn-sm"
                              href="{% url 'comment-edit' comment.id %}">Edit</a></span>
                  {% endif %}
                </div>
              </div>
              <hr>
              {% endfor %}
            </div>
          </div>
          <form method="POST">
            {% csrf_token %}
            {{ c_form|crispy }}
            <input class="btn btn-primary btn-sm" type="submit" value="Comment">
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Include Chart.js and Data Labels Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  var ctx = document.getElementById('commentsChart').getContext('2d');
  var totalComments = {{ positive_comments }} + {{ negative_comments }} + {{ mixed_comments }};
  var commentsChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: [
        'Positive: ' + {{ positive_comments }} + ' (' + ({{ positive_comments }} / totalComments * 100).toFixed(2) + '%)',
        'Negative: ' + {{ negative_comments }} + ' (' + ({{ negative_comments }} / totalComments * 100).toFixed(2) + '%)',
        'Mixed: ' + {{ mixed_comments }} + ' (' + ({{ mixed_comments }} / totalComments * 100).toFixed(2) + '%)'
      ],
      datasets: [{
        data: [
          {{ positive_comments }},
          {{ negative_comments }},
          {{ mixed_comments }}
        ],
        backgroundColor: ['#28a745', '#dc3545', '#ffc107'],
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top',
        },
        tooltip: {
          enabled: false // Disable tooltips since we show the info on the chart directly
        },
        datalabels: {
          formatter: (value, context) => {
            let label = context.chart.data.labels[context.dataIndex];
            return label;
          },
          color: '#fff',
          backgroundColor: context => context.dataset.backgroundColor,
          borderRadius: 3,
          font: {
            weight: 'bold'
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
});
</script>
{% endblock %}
